# Space Exchange (Космическая биржа)

**Space Exchange** — это учебный проект, реализующий торговую платформу для покупки и продажи виртуальных ресурсов между космическими станциями. Проект иллюстрирует использование **трёх различных протоколов** (TCP, UDP, WebSocket) в рамках одного решения.

## Функциональность

1. **TCP** — **Регистрация** кораблей. Клиент, при первом подключении, отправляет своё имя корабля; сервер регистрирует корабль и отвечает **уникальным идентификатором сессии** (sessionId).
2. **UDP** — **Потоковая передача цен**. Сервер каждые 30 секунд рассылает обновлённые цены на виртуальные ресурсы (например, «QuantumOre», «SpaceMineral» и т.д.). Клиент принимает UDP‑пакеты и отображает в интерфейсе новые цены.
3. **WebSocket** — **Аукционные события** и «События дня».
    - Каждые 1–5 минут сервер генерирует случайное событие («Выпал редкий лот!», «Событие дня»). Все подключённые клиенты получают эти уведомления по WebSocket.
    - Также клиент может отправлять **заявки на покупку/продажу** через WebSocket:
        - `{"Action": "Buy", "SessionId": "...", "Resource": "QuantumOre", "Amount": 10}`
        - `{"Action": "Sell", ...}`

Таким образом **3 протокола** позволяют:
- TCP — авторизация и базовая информация,
- UDP — «реальное время» (частые обновления),
- WebSocket — гибкая событийная модель и интерактивные аукционные механики.

## Структура проекта

В решении (**Solution**) присутствуют **два** проекта:

1. **SpaceExchangeServer** (консольный .NET-проект).
    - `Program.cs` поднимает три «точки входа»:
        - TCP (`StartTcpServer`)
        - UDP (`StartUdp`)
        - WebSocket (`StartWebSocket`)
    - Периодически генерируются события (метод `StartPeriodicTasks`):
        - «События дня» раз в 1–5 минут (WebSocket)
        - Обновление цен каждые 30 сек (UDP)
    - Обрабатывает заявки на покупку/продажу (JSON) в `ReceiveWebSocket`.

2. **SpaceExchangeClientWpf** (WPF-приложение на C#).
    - Позволяет добавлять несколько серверов (IP, порты TCP/UDP/WS), подключаться к любому выбранному.
    - При **TCP**-подключении получает `sessionId`.
    - **UDP** — слушает обновления цен и отображает в логе.
    - **WebSocket** — подписывается на «События дня»; может отправлять запросы «Buy»/«Sell».
    - Хранит последние события в локальном кэше (и выводит в UI).

## Как запустить

1. **Соберите весь Solution** в вашей IDE (Rider / Visual Studio / др.). Убедитесь, что нет ошибок сборки.

2. **Запустите сервер (SpaceExchangeServer)**:
    - В консоли отобразится:
      ```
      === SpaceExchangeServer запущен ===
      TCP-сервер слушает порт 5001.
      UDP-сервер готов вещать на порт 5002 (broadcast).
      WebSocket-сервер слушает: http://localhost:5003/ws/
      ...
      ```  
    - Сервер начинает слушать порты и периодически рассылать «события».

3. **Запустите клиент (SpaceExchangeClientWpf)**:
    - Откроется окно WPF.
    - Введите IP (например, `localhost` или `127.0.0.1`) и порты (`5001`, `5002`, `5003`), нажмите «Добавить сервер».
    - Выберите сервер в списке → «Подключиться».
        - В логе клиента отобразится sessionId, начало прослушки UDP, WebSocket-подключение.

4. **Проверка**:
    - Пример лога в клиенте:
      ```
      [12:10:45] TCP: Получен sessionId=1234-5678-...
      [12:10:45] UDP: запущено прослушивание...
      [12:10:46] WebSocket: Подключено.
      [12:11:15] UDP: {"QuantumOre":300,"SpaceMineral":120,...}
      [12:12:02] WebSocket: Событие дня: Уникальный лот №5672!
      ```
    - Для «торговых операций» (покупка/продажа) откройте специальное окно (TradeWindow) или отправьте запрос. Сервер ответит JSON с результатом сделки.

## Технологии

- **C# / .NET 6/7/8**
- **WPF** для клиентского интерфейса (Windows).
- **TCP, UDP, WebSocket** через стандартные классы (`TcpListener`, `UdpClient`, `HttpListener` / `WebSocket`).
- **Json** с помощью `System.Text.Json`.

## Архитектура

- **SpaceExchangeServer**:
    - **Program.cs**: Инициализация и запуск трёх протоколов.
    - **ExchangeService.cs**: Имитация биржи (память о кораблях, метод `UpdateResourcePrices`, методы `BuyResource`/`SellResource`).
    - **Models**: Классы `Ship`, `TradeResult`, `AuctionRequest` и т.д.

- **SpaceExchangeClientWpf**:
    - **MainWindow.xaml/.cs**: UI для подключения к серверу и вывода лога событий.
    - **TradeWindow.xaml/.cs**: отдельное окно для отправки заказов на покупку/продажу.
    - **ServerInfo.cs**: модель хранения данных о серверах (IP, порты).

## Основные сценарии

1. **Подключение**:
    1. Клиент вызывает `ConnectTcp` → отправляет имя корабля → получает `sessionId`.
    2. Клиент открывает `UdpClient` на `server.UdpPort` для получения «живых» цен.
    3. Клиент создает `ClientWebSocket` → `ws://localhost:5003/ws/` → подписывается на события.

2. **Регистрация** (TCP):
    - Сервер сохраняет корабль (с `sessionId`) во внутреннем словаре; возвращает `sessionId`.

3. **Покупка / Продажа** (WebSocket):
    - Клиент отправляет JSON:
      ```json
      { "Action": "Buy", "SessionId": "<...>", "Resource": "QuantumOre", "Amount": 10 }
      ```
    - Сервер проверяет баланс/инвентарь, меняет данные в `ExchangeService`, возвращает результат.

4. **Периодические события** (WebSocket, 1–5 минут):
    - Сервер через `BroadcastWebSocketEvent(...)` шлёт всем клиентам уведомление: «Событие дня: Уникальный лот №...».
    - Клиент видит `WebSocket: Событие дня: ...` в логе.

5. **Обновление цен** (UDP, каждые 30 сек):
    - Сервер вызывает `UpdateResourcePrices()`, рассылает текущие цены JSON вида:
      ```json
      { "QuantumOre": 210, "SpaceMineral": 130, ... }
      ```
    - Клиент получает UDP‑пакет и выводит в логе `UDP: { ... }`.

## Требования проекта

Проект соответствует всем ключевым пунктам задания:

1. **Свободный стек** — C# + WPF + .NET.
2. **TCP, UDP, WebSocket** — все три протокола задействованы.
3. **Подключение с sessionId** (TCP), возможность выбора сервера в клиенте.
4. **Сервер генерирует данные** каждые 1–5 минут (WebSocket‑события).
5. **UDP** — потоковая передача меняющихся данных (цены).
6. **Локальный кэш** — клиент хранит все события (лог) в памяти и UI.
7. **Событийная система** — «События дня», уведомления о покупках, редких артефактах.
8. **Ничего не пропущено** — все пункты соблюдены.

## Дополнительно

- Можно расширить сервис, хранящий данные о кораблях, ресурсах и сделках, использовать БД (SQL/NoSQL), внедрить аутентификацию и т.п.
- Для отображения графиков изменения цен в клиенте можно добавить дополнительный модуль, подписанный на UDP.
- Поддержка нескольких клиентов на одном сервере уже есть — WebSocket‑подключения обрабатываются списком `_wsConnections`.

---

- Используется стандартная библиотека .NET (`System.Net`, `System.Text.Json`) и WPF‑механизмы XAML.

:rocket: **Удачи в космической торговле!**